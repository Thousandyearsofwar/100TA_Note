# 光照基础
+ ## 颜色空间
+ ## 模型与材质
+ ## 基础语法介绍
+ ## 传统经验光照模型
+ ## Bump Map的改进
  + ### Bump Mapping 介绍
    + #### 物体细节可以分为三个尺度，微观，中观，宏观，
      + ##### 微观：远小于一个像素，通常在Fragment Shader中使用着色模型模拟微表面
      + ##### 中观：覆盖几个像素，包含细节足够复杂，无法用单一三角形进行有效地渲染，能够分辨出像素间曲率的变化,</br>凹凸映射常用于体现中观尺度的建模。
      + ##### 宏观：覆盖多个像素，常用顶点和三角形或者其他几何图元进行表示
    +  #### 核心思路：
       +  代替使用纹理改变光照渲染方程的颜色分量，而是使用纹理修改模型表面法线，有效提升物体
          的真实感的同时不需要额外的提升物体的几何复杂度，这种方式在提升物体的表面细节或表面
          的不规则方面有显著效果。
    + #### Bump Mapping的分类：
      + Normal
      + Parallax
      + Relief
  + ### Normal Mapping 法线映射
    + 法线贴图一开始是以世界空间法线引入的，法线贴图通过编码(x,y,z)映射到[-1,1]，世界空间法
      线映射很简单，对于每个像素上的法线直接取贴图上的值，映射回[-1,1]直接使用就可以了。法线
      贴图也可以被定义在模型空间中，定义在模型空间中的法线贴图跟定义在世界空间的法线贴图相比，
      即便是物体旋转之后，采样得到的法线也依旧有效。
    + 然而，对于世界空间和模型空间的法线都是把纹理绑定到模型的特定面的特定方向，限制了纹理的复
      用性。
    + 因此，扰动法线通常是才切线空间下，在切线空间下，能够允许模型表面变形之后法线依旧能够最大
      程度的复用，而且切线空间的法线贴图也能够很好的压缩，因为Z分量的符号位大部分都是正的。导致
      切线空间下的法线贴图通常呈现蓝色。
      ![图 1](https://i.loli.net/2021/06/26/2Rleo4AdECgN3mU.png)  
    + #### 切线空间
      + 对于Bump Mapping，法线必须相对于某些空间改变方向，为此每个顶点上存储切空间基
       (tangent frame/tangent space basic)，通过这个坐标系，在计算光照的时候，将光照运算
       用到的向量统一转换到同一个坐标系下。所以为了构建切线空间，在顶点上除了存储了顶
       点法线，还存储了切线(tangent)，副切线(bitangent)。副切线也被错误的被认为是副法线
       向量(binormal)
      + 一般切线方向是和纹理UV坐标系一致[各向异性高光就需要让切线方向和纹理U方向保持一致]，
      副切线则由顶点法线和切线叉乘得到。
      + TBN矩阵
       法线N,切线T,副切线B,三个向量作为切线空间坐标系的正交基。使用这三个向量的标准正交基
       来构建转换矩阵。[原因在MVP矩阵空间转换章节]
       $TBN=
       \begin{bmatrix}
       T_x&B_x&N_x\\
       T_y&B_y&N_y\\
       T_z&B_z&N_z\\
       \end{bmatrix}
       $
       $TBN^{-1}=
       \begin{bmatrix}
       T_x&B_x&N_x\\
       T_y&B_y&N_y\\
       T_z&B_z&N_z\\
       \end{bmatrix}^T=
       \begin{bmatrix}
       T_x&T_y&T_z\\
       B_x&B_y&B_z\\
       N_x&N_y&N_z\\
       \end{bmatrix}
       $
       + ##### 切线空间转换到世界空间$TBN^{-1}$:注意填充是行优先填充/左乘矩阵
          ![图 2](https://i.loli.net/2021/06/26/IJSBrQ1TEX4esRo.png)  
          Core/Spacetransform.hlsl</br>
          ![图 3](https://i.loli.net/2021/06/26/6EfOlZxGyQqCMTI.png)  
       + ##### Unity中法线贴图的压缩格式
         + 在非移动平台上，unity会把法线贴图转化成DXT5nm格式，这个格式只有两个有效通道GA通道，
         另外还有一个格式是BC5使用的是RG通道，而移动平台则是使用传统的RGB通道。
         通过使用两个通道的值就可以运用normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));
         获取Z分量。</br>
         ![图 4](https://i.loli.net/2021/06/26/utByZwfiO3Da5TN.png) </br>
         ![图 5](https://i.loli.net/2021/06/26/fh2lNqVaO9tJLiK.png)  </br>
         ![图 6](https://i.loli.net/2021/06/26/hio9dvgkLGaeUKs.png)  
        + ##### 纹理插值带来的影响
  + ### Parallax Mapping 视差映射
    + 为了解决当视线向量发生移动时，不会随着视角出现互相遮蔽的现象。视差贴图的概念在2001年被Kaneko提
      出，并由Welsh进行改进和推广。视差是指当观察者移动时，物体的位置也相对进行移动，并且也应当看起来
      具有高度，视差映射的关键思想是通过采样可视像素高度来对应该看到的像素进行有根据的计算猜测。
    + 对于视差贴图，凹凸值存储在高度场贴图当中。当对指定位置的像素着色时，对高度图进行采样得到高度场值，
      并用于偏移纹理坐标以得到表面纹理不同的部分。偏移的幅度取决于得到的高度值，以及视线方向于着色表面
      的角度。
    + 采样高度图之后，还可以通过Scale和Offset的操作对高度值做缩放和偏移调整
    + 给定一个采样的纹理坐标P，调整过的高度值为h，以及一个归一化过后的观察向量V(高度值为V.z，水平面分量为
      V.xy)，则得到偏移之后的纹理坐标为：
      #### ${p}'_{adj}=p+\frac{h\cdot V_{xy}}{v.z}$[计算空间在切线空间]
      #### $h=h*scale+offset$
    + 低视角平面修正
      + 在高度变化相对缓慢的视差效果是比较好的，邻近的像素偏移高度也差不多，但是在低视角平面时，微小的高度
        变化会导致极大的纹理坐标偏移，这样的近似是错误的。
      + 为了修正这个问题，Welsh提出了限制偏移的做法，目的是限制偏移量，使其永远不会超出其能够检索到的高度。
       #### ${p}'_{adj}=p+h\cdot V_{xy}$[计算空间在切线空间]
       #### $h=h*scale+offset$
        ![图 7](https://i.loli.net/2021/06/27/YWodQsGTzkF28hc.png)  
    + 压缩问题：
      + 需要注意当高度图填充到其他贴图的Alpha通道[或者其他通道]时，注意压缩算法是否会对Alpha通道有影响。
    + #### Steep Parallax Mapping 陡峭视差映射
      + 为了解决普通视差计算值是近似值所造成的纹理游泳问题，所以提出了更加精确求值的Steep Parallax Mapping
        + 基本思路：
          + 将深度等距划分成若干层，然后从最顶端开始采样，并且每次往视角方向偏移一定的值，采样当前位置的深度值，
            如果当前采样得到的深度大于原本一开始采样得到的深度，则停止采样返回结果。
          ![图 2](https://i.loli.net/2021/06/27/Z95RIdwPvYBJlxE.png)  
        + 走样问题：
          + 提高采样次数[步进次数]
  + ### Relief Mapping/Parallax Occlusion Mapping 
    + 视差映射提供了一个高度场效果的近似求解，POM对比于普通的视差映射，求出来偏移的值更加准确。也能够带有自阴影
      以及Occlusion</br>
      ![图 3](https://i.loli.net/2021/06/27/kVWpcLdSl5za2ob.png)  
    + 基本思路：
      + 先沿着投影向量采样一个固定数量的高度场纹理值，对于掠射视角的位置，通常会采样次数会变多，这样就不会错过
        最近的交点。沿着射线的每一个三维坐标位置都能被检索到，并转换到纹理纹理空间采样判断当前采样的深度值是否
        高于还是低于原本位置的高度场，一旦找到低于原本位置的高度，就会根据上一次采样得到高度在原本高度之上的深
        度和当前采样低于原本高度的深度之间查找交点/插值。
      + 最后一步：
        + 查找的方法：
          + 二分查找
          ![图 4](https://i.loli.net/2021/06/27/c7aNqYbFtDpj2Ms.png)  
        + 放弃二分查找直接使用插值的结果。 
  + ### 结合PBR/基础光照着色对比
    + 在作业点评里，may佬说要结合IBL，国内的文章真没有说这玩意的，后来在搜索Google的时候发现10年的Paper，好家伙。</br>
    ![图 1](https://i.loli.net/2021/07/04/P6nfcL2BOdhNtFm.png)</br>  
    另外其他我找到关于优化POM的paper和GDC的ppt都放到群共享里了</br>
    + 对比：
      + Parallax
       ![图 1](https://i.loli.net/2021/07/04/Z7xhlFTrQLAc1aO.png)  
      + Steep parallax
       ![图 2](https://i.loli.net/2021/07/04/O9E1ZhBl5aXxHnm.png)  
      + POM 自阴影待续
       ![图 3](https://i.loli.net/2021/07/04/RVgzEu4vkAsW2G9.png)  
      + QDM待续
      + 结合IBL待续
      + 使用SRP的PerPixelDisplacement.hlsl
+ ## 伽马矫正
+ ## LDR与HDR
+ ## FlowMap的实现
+ ## 待续